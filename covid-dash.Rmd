---
title: "Understanding the COVID-19 pandemic through data"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: rows
resource_files:
- .Renviron
---
  
```{r setup, include=FALSE}
source("styles.R")
source("00_setup.R")
# Load data from server
dfm            <- fst::read_fst(paste0(data_path, "dfm.fst"))
ccc            <- fst::read_fst(paste0(data_path, "ccc.fst"))
fullcd2        <- fst::read_fst(paste0(data_path, "fullcd2.fst"))
wld_data       <- fst::read_fst(paste0(data_path, "wld_data.fst"))
indicator_list <- fst::read_fst(paste0(data_path, "indicator_list,fst"))
new_c          <- fst::read_fst(paste0(data_path, "new_c.fst"))
new_wl         <- fst::read_fst(paste0(data_path, "new_wl.fst"))
tmp            <- readr::read_rds(paste0(data_path, "temporary_file,rds"))
age_pop        <- readr::read_rds(paste0(data_path, "age_pop.RDS"))
covid          <- readr::read_rds(paste0(data_path, "covid.RDS"))
health         <- readr::read_rds(paste0(data_path, "health.RDS"))
water          <- readr::read_rds(paste0(data_path, "water.RDS"))
cg_data        <- readr::read_rds(paste0(data_path, "cg_data.RDS"))

my_date <- max(wld_data$date)
my_date2 <- format(as.Date(my_date), format = "%b %d")
my_date2 <- as.character(my_date2)
today <- as.Date(my_date) + 1

#--------- filtered cases
covid <- grep("(Confirmed|Deaths)", covid, value = TRUE)


#------country palette
#This has to be done here and not in utils because Ineed the `fullcd2` dataframe

uniq_cty <- unique(fullcd2$`Short Name`)

cty_color <-  setNames(
  rep(palette, ceil(length(uniq_cty)/length(palette)))[1:length(uniq_cty)],
  uniq_cty
)


```


Indicators
=====================================
  
Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------
Last Updated on: `r today`

```{r}

selectInput("variable",
            "Indicator Y-axis:",
            choices = list(
              `Age & Population` = age_pop,
              `COVID-19` = covid,
              Health = health,
              `Water & Sanitation` = water),  
            selected = "COVID-19 Cases: Deaths"
)    

selectInput("variable2",
            "Indicator X-axis:",
            choices = list(
              `Age & Population` = age_pop,
              `COVID-19` = covid,
              Health = health,
              `Water & Sanitation` = water),                
            selected = "Population ages 65 and above (% of total)"
) 

selectInput("size",
            "Bubble size:",
            choices = covid,                
            selected = "COVID-19 Cases: Confirmed"
) 

selectizeInput("Country Name",
               "Country (compare countries over time):",
               c(unique(as.character(dfm$`Short Name`))),
               multiple = TRUE, 
               selected = c("China", "Italy", "United States", "Spain", "Iran")
)
```

Row  {data-height=130}
-----------------------------------------------------------------------
### World
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(`COVID-19 cases: Confirmed`)
  con <- format(con, big.mark=",")
  de <- HTML(paste0("Total cases:<br/>", con))
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
  )
})
```

### World
```{r}
renderValueBox({
  con <- new_wl %>% 
    filter(status == "Confirmed") %>% 
    select(con) %>% 
    pull() %>% 
    format(big.mark=",")
  
  de <- HTML(paste0("New cases (", my_date2, "):<br/>", con))
  #de <- str_wrap(de, 15)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
  )
})
```

### World
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(`COVID-19 cases: Deaths`)
  con <- format(con, big.mark=",")
  de <- HTML(paste0("Total deaths:<br/>", con))
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
  )
})
```

Row  {data-height=500}
-----------------------------------------------------------------------
  
### Explore relationships
```{r}
renderPlotly ({
  
  df2 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable, ]
  df3 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable2, c(1, 6)]
  dfs <- dfm[dfm$date == 2019 & dfm$variable %in% input$size, c(1, 6)]
   
    dfs <- dfs %>%
          rename("siz" = "mrv")

     
    df3 <- df3 %>%
          rename("mrv2" = "mrv")
  
    df4 <- merge(df2, df3, by = c("iso3c"))   
    df4 <- merge(df4, dfs, by = c("iso3c"))  
  
    m <- df4[df4$`Short Name` %in% input$`Country Name`,]
    a <- list(x = m$mrv2, y = m$mrv,
              text = m$`Short Name`, 
              xref = "x", 
              yref = "y",
              showarrow = TRUE, 
              arrowhead = 0, 
              ax = 20, 
              ay = -40, 
              arrowcolor= toRGB("grey80"),
              font = list(color = "dark grey", size = 14)
              )
    
    df4 <- df4 %>% 
      mutate(
        opacity = if_else(`Short Name` %in% input$`Country Name`, 0.95, 0.3)
      )
    
     texty <- paste("</br>", df4$`Short Name`,
                    "</br>X: ", round(df4$mrv2, 1),
                    "</br>Y: ", round(df4$mrv, 1))
    
    plot_ly(data = df4) %>%
      add_trace(
        x = ~ mrv2,
        y = ~ mrv,
        type = 'scatter',
        mode = 'markers',
        color = ~Region,
        colors = reg_color,
        opacity = 0.9,
        size   = ~siz,
        sizes  = c(20, 100),
      hoverinfo = 'text',
      text = ~ texty
      ) %>%
    #add_annotations(text = df4$lab, textfont = list(size = 14),
    #         textposition = "top right") %>% 
      layout(legend = list(x = 0, 
                           y = -0.3, 
                           orientation = 'h'
                           ),
             annotations = a,
             xaxis = list(zeroline = FALSE, 
                          showline = FALSE, 
                          showgrid = TRUE, 
                          title = str_wrap((input$variable2), 40),
                          range = c(min(df4$variable), max(df4$variable))
                          ),
             yaxis = list(zeroline = FALSE, 
                          showline = FALSE, 
                          showgrid = TRUE, 
                          title = str_wrap(input$variable, 40),
                          range = c(min(df4$variable), max(df4$variable))
                          )
             )
      })
```


### Compare countries over time
```{r}

uiOutput("dynamic")

output$dynamic <- renderUI({ 
  if (input$variable %in% covid){
    plotlyOutput("plot1")
  } else {
    plotlyOutput("plot2")
  }
})

output$plot1 <- renderPlotly({
  
  dft <- fullcd2[fullcd2$`Short Name` %in% input$`Country Name`
                 & fullcd2$variable %in% input$variable,]
  
dft <- dft    %>%
  arrange(date) %>% 
  group_by(Region) %>% 
  mutate(
    op = match(name, unique(name)), 
    opacity = (1-(op/max(op))+1/max(op)),
  ) %>% 
  ungroup() %>% 
  mutate(
    colors = rep(palette, ceil(nrow(.)/length(palette)))[1:nrow(.)]
  )  
  
  # op <- dft %>% 
  #   group_by(`Short Name`) %>% 
  #   summarise(opacity = mean(opacity))
  # 
  # opacity  <- setNames(
  #   op$opacity,
  #   op$`Short Name`
  # )
  # rm(op)
  
  texty <- paste("</br>", dft$`Short Name`,
                 "</br>Y: ", dft$value, 
                 "</br>Date: ", dft$date)
  
  plot_ly(data = dft,
          x = ~date,
          y = ~ value ) %>%
    add_trace(

      name  = ~ `Short Name`, 
      type  = 'scatter',
      mode  = 'lines+markers', 
      color = ~`Short Name`,
      colors = cty_color,
      hoverinfo = 'text',
      text = ~ texty
    ) %>%
    layout(
      legend = list(orientation = 'h'),
      xaxis = list(
        title = '',
        zeroline = FALSE,
        showline = FALSE,
        showgrid = TRUE
      ),
      yaxis = list(
        title = input$variable,
        zeroline = FALSE,
        showline = FALSE,
        showgrid = TRUE
      )
    )
  
})

output$plot2 <- renderPlotly({
  
  df1 <- dfm[dfm$`Short Name` %in% input$`Country Name` 
             & dfm$variable %in% input$variable,]
  
  df1 <- df1 %>%
    group_by(iso3c) %>%
    arrange(date) %>%
    mutate(date = as.numeric(date)) %>% 
    ungroup() %>% 
    mutate(
      colors = rep(palette, ceil(nrow(.)/length(palette)))[1:nrow(.)]
    )

  
  texty <- paste("</br>", df1$`Short Name`,
                 "</br>Y: ", round(df1$value, 1), 
                 "</br>Year: ", df1$date)
  
  plot_ly(df1) %>%
    add_trace(
      x = ~ date,
      y = ~ value,
      name = ~ `Short Name`,
      type = 'scatter',
      mode = 'lines+markers',
      color = ~`Short Name`,
      colors = cty_color,
      hoverinfo = 'text',
      text = ~ texty
    ) %>%
    layout(legend = list(orientation = 'h'),
           xaxis = list(title = '', 
                        zeroline = FALSE, 
                        showline = FALSE, 
                        showgrid = TRUE
           ), 
           yaxis = list(title = str_wrap(input$variable, 40), 
                        zeroline = FALSE, 
                        showline = FALSE, 
                        showgrid = TRUE
           )
    )
  
})

```

COVID-19 Case Data
=====================================
  
Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------
Last Updated on: `r today`
  
```{r}

radioButtons("var",
             "",
             choices = covid,  
             selected = "COVID-19 Cases: Confirmed"
)   

getind <- reactive({
  input$var
})

```

<!-- Row  {data-height=130} -->
  <!-- ----------------------------------------------------------------------- -->
  <!-- ### Selected country, `r my_date` -->
  <!-- ```{r} -->
  
  <!-- renderValueBox({ -->
      <!--     con <- fullcd2[(fullcd2$variable == "COVID-19 Cases: Confirmed" & -->
                                 <!--                    fullcd2$date == max(fullcd2$date) & -->
                                 <!--                    fullcd2$`Short Name` == input$Country), "value"] -->
        <!--     con <- format(con, big.mark=",") -->
          <!--     de <- paste0("Confirmed: ", con) -->
            <!--   valueBox(tags$p(de, style = "font-size: 80%;") -->
                              <!--            #, -->
                              <!--            #icon = "fa-users" -->
                              <!--            ) -->
            <!-- }) -->
  <!-- ``` -->
  
  <!-- ### Selected country, `r my_date` -->
  <!-- ```{r} -->
  <!-- renderValueBox({ -->
      <!--     con <- fullcd2[(fullcd2$variable == "COVID-19 Cases: Active" & -->
                                 <!--                    fullcd2$date == max(fullcd2$date) & -->
                                 <!--                    fullcd2$`Short Name` == input$Country), "value"] -->
        <!--     con <- format(con, big.mark=",") -->
          <!--     de <- paste0("Active: ", con) -->
            <!--   valueBox(tags$p(de, style = "font-size: 80%;") -->
                              <!--            #, -->
                              <!--            #icon = "fa-users" -->
                              <!--            ) -->
            <!-- }) -->
  <!-- ``` -->
  
  <!-- ### Selected country, `r my_date` -->
  <!-- ```{r} -->
  <!-- renderValueBox({ -->
      <!--     con <- fullcd2[(fullcd2$variable == "COVID-19 Cases: Deaths" & -->
                                 <!--                    fullcd2$date == max(fullcd2$date) & -->
                                 <!--                    fullcd2$`Short Name` == input$Country), "value"] -->
        <!--     con <- format(con, big.mark=",") -->
          <!--     de <- paste0("Deaths: ", con) -->
            <!--   valueBox(tags$p(de, style = "font-size: 80%;") -->
                              <!--            #, -->
                              <!--            #icon = "fa-users" -->
                              <!--            ) -->
            <!-- }) -->
  <!-- ``` -->
  
Row
-----------------------------------------------------------------------
### `r renderText(getind())`
  
```{r}
renderPlotly({
  
  tmp <- fullcd2[(fullcd2$variable %in% input$var),]  
  
  tmp <- tmp[tmp$date == max(tmp$date),]
  tmp <- tmp[!is.na(tmp$Region),]
  
  # Compute regional aggregates
  tmp2 <- tmp %>%
    select(Region) %>%
    distinct() %>%
    mutate(
      `Short Name` = unique(Region),
      Region = "World",
      value = 0
    )
  
  # Combine Regional aggregates with country level data
  tmp3 <- bind_rows(tmp, tmp2) %>%
    select(Region, `Short Name`, value) %>%
    filter(
      Region %in% c("World", "Europe & Central Asia", "East Asia & Pacific", 
                    "North America", "Middle East & North Africa", "Latin America & Caribbean", 
                    "South Asia", "Sub-Saharan Africa")
    ) %>% 
    left_join(color_map2) %>% 
    left_join(color_map2, by = c("Short Name" = "Region")) %>% 
    mutate(
      color = if_else(is.na(color.x), color.y, color.x)
    ) %>% 
    select(-color.x, -color.y)
  
  tmp3 %>%
    plot_ly( 
      type    = "treemap",
      labels  = ~`Short Name`,
      parents = ~Region,
      values  = ~value,
      marker  = list(colors = ~color)
    ) 
  
})


```


### `r renderText(getind())`

```{r}

renderPlotly({
  
  dfb <- fullcd2 %>% 
    filter(date == max(date),
           variable %in% input$var) %>%
    arrange(desc(value))  %>%
    mutate(`Short Name` = fct_reorder(`Short Name`, desc(value))) %>% 
    slice(1:20)
  
  texty <- paste("</br>", dfb$`Short Name`,
                 "</br>Y: ", dfb$value, 
                 "</br>Date: ", dfb$date)
  
  plot_ly(dfb, 
          type = 'bar', 
          x = ~`Short Name`, 
          y = ~value, 
          color = ~Region,
          colors = reg_color,
          hoverinfo = 'text',
          text = ~ texty
  ) %>% 
    layout(
      legend = list(orientation = 'h', 
                    y = 100, 
                    x = 0),
      xaxis = list(title = '', 
                   zeroline = FALSE, 
                   showline = FALSE, 
                   showgrid = TRUE
      ), 
      yaxis = list(title = '', 
                   zeroline = FALSE, 
                   showline = FALSE, 
                   showgrid = TRUE
      )
    )
})


```


<!-- Center of gravity -->
<!-- ===================================== -->

<!-- Sidebar { .sidebar data-width=250} -->
<!-- ----------------------------------------------------------------------- -->

<!-- ```{r} -->

<!-- radioButtons("tab", "Type:", -->
<!--              c("COVID-19 Cases: Confirmed", -->
<!--                "COVID-19 Cases: Deaths") -->
<!-- ) -->
<!-- ```   -->

<!-- Row  {data-height=500} -->
<!-- ----------------------------------------------------------------------- -->

<!-- ```{r} -->
<!-- uiOutput("dynamic2") -->

<!-- output$dynamic2 <- renderUI({ -->
<!--   if (input$tab == "COVID-19 Cases: Confirmed") -->
<!--   { -->
<!--     plotOutput("map1", width = "1024px", height="700px") -->
<!--   } else { -->
<!--     plotOutput("map2", width = "800px", height="600px" ) -->
<!--   } -->
<!-- }) -->

<!-- # Loading global shapefile converted into rda -->
<!-- load(file = "input/area_df.rda") -->

<!-- # Map over daily confirmed -->
<!-- output$map1 <- renderPlot({ -->

<!--   ggplot() + -->
<!--     geom_polygon( -->
<!--       data = area_df, -->
<!--       aes(x = long, y = lat, group = group), -->
<!--       color = 'white', -->
<!--       size = 0.1 -->
<!--     ) + -->
<!--     theme( -->
<!--       panel.background = element_rect(fill = 'white', color = 'white'), -->
<!--       legend.text = element_text(size = 14), -->
<!--       legend.title = element_text(size = 14) -->
<!--     ) + -->
<!--     theme( -->
<!--       axis.title.x = element_blank(), -->
<!--       axis.text.x = element_blank(), -->
<!--       axis.ticks.x = element_blank() -->
<!--     ) + -->
<!--     theme( -->
<!--       axis.title.y = element_blank(), -->
<!--       axis.text.y = element_blank(), -->
<!--       axis.ticks.y = element_blank() -->
<!--     ) + -->
<!--     geom_point( -->
<!--       data = cg_data, -->
<!--       aes( -->
<!--         x = longitude_newconfirmed_rol, -->
<!--         y = latitude_newconfirmed_rol, -->
<!--         size = total_newconfirmed, -->
<!--         color = date -->
<!--       ) -->
<!--     ) + -->
<!--     scale_colour_date(low = "#7878FF", high = "#000078") +  -->
<!--     labs(size = "Daily new cases", color =  "Date") + -->
<!--     ggtitle("Center of Gravity of COVID-19 Cases") +  -->
<!--     theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20)) -->

<!-- })  -->

<!-- # Map over daily deaths -->
<!-- output$map2 <- renderPlot({ -->

<!--   ggplot() + -->
<!--     geom_polygon( -->
<!--       data = area_df, -->
<!--       aes(x = long, y = lat, group = group), -->
<!--       color = 'white', -->
<!--       size = 0.1 -->
<!--     ) + -->
<!--     theme( -->
<!--       panel.background = element_rect(fill = 'white', color = 'white'), -->
<!--       legend.text = element_text(size = 14), -->
<!--       legend.title = element_text(size = 14) -->
<!--     ) + -->
<!--     theme( -->
<!--       axis.title.x = element_blank(), -->
<!--       axis.text.x = element_blank(), -->
<!--       axis.ticks.x = element_blank() -->
<!--     ) + -->
<!--     theme( -->
<!--       axis.title.y = element_blank(), -->
<!--       axis.text.y = element_blank(), -->
<!--       axis.ticks.y = element_blank() -->
<!--     ) + -->
<!--     geom_point( -->
<!--       data = cg_data, -->
<!--       aes( -->
<!--         x = longitude_newdeaths_rol, -->
<!--         y = latitude_newdeaths_rol, -->
<!--         size = total_newdeaths, -->
<!--         color = date -->
<!--       ) -->
<!--     ) + -->
<!--     scale_colour_date(low = "#FF7878", high = "#780000") +  -->
<!--     labs(size = "Daily deaths", color = "Date") + -->
<!--     ggtitle("Center of Gravity of COVID-19 Deaths") +  -->
<!--     theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20)) -->

<!-- }) -->

<!-- ``` -->