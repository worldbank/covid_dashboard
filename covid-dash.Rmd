---
title: "Development data and COVID-19 pandemic"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
source("styles.R")
source("00_setup.R")
source("03_load_data.R")

```

Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------

```{r}

selectInput("variable",
               "Indicator Y-axis:",
                choices = list(
                  `Age & Population` = sort(unique(dfm[dfm$topic == "Age & Population",]$variable)),
                  `COVID-19` = sort(unique(dfm[dfm$topic == "COVID-19",]$variable)),
                   Health = sort(unique(dfm[dfm$topic == "Health",]$variable)),
                  `Water & Sanitation` = sort(unique(dfm[dfm$topic == "Water & Sanitation",]$variable))),  
                selected = "COVID-19 Cases: Confirmed"
                )    

selectInput("variable2",
               "Indicator X-axis:",
                choices = list(
                  `Age & Population` = sort(unique(dfm[dfm$topic == "Age & Population",]$variable)),
                  `COVID-19` = sort(unique(dfm[dfm$topic == "COVID-19",]$variable)),
                   Health = sort(unique(dfm[dfm$topic == "Health",]$variable)),
                  `Water & Sanitation` = sort(unique(dfm[dfm$topic == "Water & Sanitation",]$variable))),                 selected = "Hospital beds (per 1,000 people)"
                ) 

selectInput("size",
               "Size:",
                choices = list(
                  `Age & Population` = sort(unique(dfm[dfm$topic == "Age & Population",]$variable)),
                  `COVID-19` = sort(unique(dfm[dfm$topic == "COVID-19",]$variable)),
                   Health = sort(unique(dfm[dfm$topic == "Health",]$variable)),
                  `Water & Sanitation` = sort(unique(dfm[dfm$topic == "Water & Sanitation",]$variable))),                 selected = "Population ages 65 and above (% of total)"
                ) 

selectizeInput("Country Name",
                "Country:",
                c(unique(as.character(dfm$`Short Name`))),
                multiple = TRUE, selected = c("China", "Italy"))

```

Row  {data-height=500}
-----------------------------------------------------------------------

### Explore relationships
```{r}
renderPlotly ({

  df2 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable, ]
  df3 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable2, c(1, 6)]
  dfs <- dfm[dfm$date == 2019 & dfm$variable %in% input$size, c(1, 6)]
   
    dfs <- dfs %>%
          rename("siz" = "mrv")

     
    df3 <- df3 %>%
          rename("mrv2" = "mrv")
  
    df4 <- merge(df2, df3, by = c("iso3c"))   
    df4 <- merge(df4, dfs, by = c("iso3c"))  
  

  plot_ly(data = df4) %>%
    add_trace(x = ~mrv2, y = ~mrv, type = 'scatter', mode = 'markers', color = ~Region, size = ~siz, 
              opacity = ifelse(df4$`Short Name` %in% input$`Country Name`, 1, 0.5), ## opacity not working
              hoverinfo = 'text',
              text = ~paste(df4$`Short Name`)) %>%
      layout(xaxis = list(zeroline = FALSE, showline = FALSE, showgrid = T, title = input$variable2,
                          range = c(min(df4$variable), max(df4$variable))),
             yaxis = list(zeroline = FALSE, showline = FALSE, showgrid = T, title = input$variable,
                          range = c(min(df4$variable), max(df4$variable))))
      })

```


### Compare countries over time
```{r}

uiOutput("dynamic")

output$dynamic <- renderUI({ 
  if (input$variable == "COVID-19 Cases: Confirmed" | input$variable == "COVID-19 Cases: Recovered" |
      input$variable == "COVID-19 Cases: Deaths" | input$variable == "COVID-19 Cases: Active") {
    plotlyOutput("plot1")
  } else {
    plotlyOutput("plot2")
  }
})

output$plot1 <- renderPlotly({
  
  dft <- fullcd2[fullcd2$`Short Name` %in% input$`Country Name` & fullcd2$variable %in% input$variable,]  

  dft %>%
  arrange(date) %>%
  plot_ly() %>%
  add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'lines',
            color = ~`Short Name`) %>%
      add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'markers',
            color = ~`Short Name`, showlegend = FALSE) %>%
  layout(xaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T), 
         yaxis = list(title = input$variable, zeroline = FALSE, showline = FALSE, showgrid = T))

})

output$plot2 <- renderPlotly({
    
  df1 <- dfm[dfm$`Short Name` %in% input$`Country Name` & dfm$variable %in% input$variable,]  

  plot_ly(df1) %>%
  add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'lines',
            color = df1$iso3c) %>%
      add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'markers',
            color = df1$iso3c, showlegend = FALSE) %>%
  layout(xaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T), 
         yaxis = list(title = input$variable, zeroline = FALSE, showline = FALSE, showgrid = T))

})

```

Row  {data-height=130}
-----------------------------------------------------------------------
### World
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(`COVID-19 cases: Confirmed`)
    de <- paste0("Confirmed: ", con)
  valueBox(de, icon = "fa-users")
})
```

### World
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(`COVID-19 cases: Active`)
    de <- paste0("Active: ", con)
  valueBox(de, icon = "fa-users")
})
```

### World
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(`COVID-19 cases: Deaths`)
  de <- paste0("Deaths: ", con)
  valueBox(de, icon = "fa-users")
})
```

Row  {data-height=370}
-----------------------------------------------------------------------
### Confirmed cases
```{r}
plot_treemap <- function(input, case_type) {
  
  tmp <- tmp[tmp$date == max(tmp$date),]
  
#  p <- d3tree3(
   p <-  treemap(tmp,
            draw = T,
               index=c("Region", "name"),
               vSize="value",
               type="index",
               palette = "Set2",
               bg.labels = 150,
               title = "",
               border.col = "white",
               align.labels=list(
                 c("center", "center"), 
                 c("right", "bottom")
               )
#    ),
#    rootname = "World"
  )
  
  return(p)
}

renderPlot({
  plot_treemap(input, "COVID-19 Cases: Confirmed")
})

# renderD3tree3({
#   plot_treemap(input, "COVID-19 Cases: Deaths")
# })

# 
# ### Bubble map
# ```{r}
# leaflet(ccc) %>% 
#   addTiles()  %>% 
#   addCircleMarkers(~longitude, ~latitude, label = ~longlab,
#                    radius = ~ sqrt(mrv/10),
#                    stroke = FALSE, fillOpacity = 0.5, weight = 1) 
# 

# figure(
#        data = ccc,
#         plot = function(cnm, style = style_atlas_open(), quality = "low") {
#         breaks = c(200, 5000, 20000)
#         wbg_bubble_map(cnm, wbgmaps[[quality]], style, "mrv",
#         breaks,
#         max_size = 2
#         )
#         },
#         aspect_ratio = 1.5
#        )

# renderLeaflet({
#   
#   h <- reactive({
#     a <- ccc[ccc$date %in% input$date,]
#   })
#   
#   leaflet(h()) %>% 
#     addTiles()  %>% 
#     addCircleMarkers(h()$longitude, h()$latitude, label = h()$longlab,
#                      radius = h()$sqrt(value/10),
#                      stroke = FALSE, fillOpacity = 0.5, weight = 1)  
#   
# })

```

### Death cases

```{r}
renderPlot({
  plot_treemap(input, "COVID-19 Cases: Deaths")
})
```
