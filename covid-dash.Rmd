---
title: "Understanding the COVID-19 pandemic through data"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: rows
---
  
```{r setup, include=FALSE}
source("styles.R")
source("00_setup.R")

library(pins)
my_key <- Sys.getenv("connect_key")
my_server <- "http://localhost:3939/"

# UNCOMMENT FOR LOCAL USE with EXTERNAL server: 
# my_key <- Sys.getenv("connect_key_ext")
# my_server <- "http://w0lxopshyprd1b.worldbank.org:3939/" # External server

# UNCOMMENT FOR LOCAL USE with INTERNAL server:
 my_key <- Sys.getenv("connect_key_int")
 my_server <- "http://w0lxpjekins05.worldbank.org:3939/" # Internal server

board_register_rsconnect(key    = my_key,
                         server = my_server)

dfm <- pin_get("dfm", board = "rsconnect")
ccc <- pin_get("ccc", board = "rsconnect")
fullcd2 <- pin_get("fullcd2", board = "rsconnect")
wld_data <- pin_get("wld_data", board = "rsconnect")
indicator_list <- pin_get("indicator_list", board = "rsconnect")
new_c <- pin_get("new_c", board = "rsconnect")
new_wl <- pin_get("new_wl", board = "rsconnect")
tmp <- pin_get("temporary_file", board = "rsconnect")
cg_data <- pin_get("cg_data", board = "rsconnect")
age_pop <- pin_get("age_pop", board = "rsconnect")
age_pop <- age_pop$age_pop
covid <- pin_get("covid", board = "rsconnect")
covid <- covid$covid
covid <- c( "COVID-19 Cases: Case Fatality Rate",
            "COVID-19 Cases: Confirmed",
            "COVID-19 Cases: Confirmed (log scale)",
            "COVID-19 Cases: Confirmed (per 1,000 people)",
            "COVID-19 Cases: Confirmed (per 1,000 people, log scale)",
            "COVID-19 Cases: Deaths",
            "COVID-19 Cases: Deaths (log scale)",
            "COVID-19 Cases: Deaths (per 1,000 people)",
            "COVID-19 Cases: Deaths (per 1,000 people, log scale)",
            "COVID-19 Cases: New Confirmed cases (Daily)",
            "COVID-19 Cases: New Deaths (Daily)")
covidlog <- covid[stringr::str_detect(covid, "log scale")]
covidbubble <- covid[!stringr::str_detect(covid, "log scale")]
covid_treemap <- covid[!stringr::str_detect(covid, paste(c("log scale", "Fatality", "per 1,000 people"),collapse = '|'))]
health <- pin_get("health", board = "rsconnect")
health <- health$health
water <- pin_get("water", board = "rsconnect")
water <- water$water


my_date <- max(wld_data$date)
my_date2 <- format(as.Date(my_date), format = "%b %d")
my_date2 <- as.character(my_date2)
today <- as.Date(my_date) + 1

#--------- filtered cases
covid <- grep("(Confirmed|Deaths)", covid, value = TRUE)


#------country palette
#This has to be done here and not in utils because Ineed the `fullcd2` dataframe

uniq_cty <- unique(fullcd2$`Short Name`)

cty_color <-  setNames(
  rep(palette, ceil(length(uniq_cty)/length(palette)))[1:length(uniq_cty)],
  uniq_cty
)

#---------- prep for pyramid chart

library(wbstats)
library(dplyr)
library(plotly)

#indicators1 <- c("SP.POP.TOTL", "SP.DYN.CDRT.IN", "SP.DYN.CBRT.IN")
#indicators2 <- c("SP.POP.GROW", "SP.DYN.CDRT.IN", "SP.DYN.CBRT.IN")
indicators1 <- c("SP.POP.0004.MA.5Y", "SP.POP.1014.MA.5Y", "SP.POP.0509.MA.5Y", 
                 "SP.POP.1519.MA.5Y", "SP.POP.2024.MA.5Y", "SP.POP.2529.MA.5Y",
                 "SP.POP.3034.MA.5Y", "SP.POP.3539.MA.5Y", "SP.POP.4044.MA.5Y",
                 "SP.POP.4549.MA.5Y", "SP.POP.5054.MA.5Y", "SP.POP.5559.MA.5Y",
                 "SP.POP.6064.MA.5Y", "SP.POP.6569.MA.5Y", "SP.POP.7074.MA.5Y",
                 "SP.POP.7579.MA.5Y", "SP.POP.80UP.MA.5Y")

indicators2 <- c("SP.POP.0004.FE.5Y",  "SP.POP.1014.FE.5Y", "SP.POP.0509.FE.5Y", 
                 "SP.POP.1519.FE.5Y", "SP.POP.2024.FE.5Y", "SP.POP.2529.FE.5Y", 
                 "SP.POP.3034.FE.5Y", "SP.POP.3539.FE.5Y", "SP.POP.4044.FE.5Y", 
                 "SP.POP.4549.FE.5Y", "SP.POP.5054.FE.5Y", "SP.POP.5559.FE.5Y", 
                 "SP.POP.6064.FE.5Y", "SP.POP.6569.FE.5Y", "SP.POP.7074.FE.5Y", 
                 "SP.POP.7579.FE.5Y", "SP.POP.80UP.FE.5Y")

indicators <- c("SP.POP.TOTL.MA.IN", "SP.POP.TOTL.FE.IN")

df1 <- wb(
  c("LIC", "LMC", "UMC", "HIC"),
  indicator = indicators1,
  startdate = 2018,
  enddate = 2018,
  return_wide = FALSE
  )
  
df2 <- wb(
  c("LIC", "LMC", "UMC", "HIC"),
  indicator = indicators2,
  startdate = 2018,
  enddate = 2018,
  return_wide = FALSE
)
  
df3 <- wb(
  c("LIC", "LMC", "UMC", "HIC"),
  indicator = indicators,
  startdate = 2018,
  enddate = 2018,
  return_wide = TRUE
) %>%
  select("iso3c", "SP.POP.TOTL.MA.IN", "SP.POP.TOTL.FE.IN")
  
  df1 <- merge(df1, df3, "iso3c")
  df1$value2 <- (df1$value * df1$SP.POP.TOTL.MA.IN)/100
  
  df2 <- merge(df2, df3, "iso3c")
  df2$value2 <- (df1$value * df1$SP.POP.TOTL.FE.IN)/100
  
  df <- rbind(df1, df2)
  
  df$gender <- substr(df$indicatorID, 13, 14)
  df$startage <- substr(df$indicatorID, 8, 9)
  df$endage <- substr(df$indicatorID, 10, 11)
  df$age <- paste0(df$startage, "-", df$endage)
  df$age[df$age == "80-UP"] <- "80+"
  
  df$age <- as.factor(df$age)

  df$value3 <- ifelse(df$gender == "MA", df$value2*-1, df$value2)
  
   pyr <- function(x) {
    
    dflic <-  df[df$iso3c == x,]
    
    plot_ly(dflic, x = ~value3, y = ~age, color = ~gender) %>%
      add_bars(orientation = "h",
               hoverinfo = "text", text = paste('</br> Age group:', dflic$age,
                                                '</br> Population:', round((dflic$value2)/1000000,1), "million"), 
               colors = c("#00a996", "orange")) %>%
      layout(bargap = 0.1, barmode = "overlay", 
             title = "", 
             xaxis = list(tickmode = "array", 
                          title = "Population (millions)"), 
             yaxis = list(title = "")) 
    
    
  }

```


Indicators
=====================================
  
Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------
Last Updated on: `r today`

```{r}

selectInput("variable",
            "Indicator Y-axis:",
            choices = list(
              `Age & Population` = age_pop,
              `COVID-19` = covid,
              Health = health,
              `Water & Sanitation` = water),  
            selected = "COVID-19 Cases: Deaths"
)    

selectInput("variable2",
            "Indicator X-axis:",
            choices = list(
              `Age & Population` = age_pop,
              `COVID-19` = covid,
              Health = health,
              `Water & Sanitation` = water),                
            selected = "Population ages 65 and above (% of total)"
) 

#selectInput("size",
#            "Bubble size:",
#            choices = covidbubble,                
#            selected = "COVID-19 Cases: Confirmed"
#) 

selectizeInput("Country Name",
               "Country (compare countries over time):",
               c(unique(as.character(dfm$`Short Name`))),
               multiple = TRUE, 
               selected = c("China", "Italy", "United States", "Spain", "Germany", "France")
)
```

Row  {data-height=130}
-----------------------------------------------------------------------
### World
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    pull(`COVID-19 cases: Confirmed`) 
  con <- format(con, big.mark=",")
  de <- HTML(paste0("Total cases:<br/>", con))
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
  )
})
```

### World
```{r}
renderValueBox({
  con <- new_wl %>% 
    filter(status == "Confirmed") %>% 
    pull(con) %>% 
    format(big.mark = ",")
  
  de <- HTML(paste0("New cases (", my_date2, "):<br/>", con))
  #de <- str_wrap(de, 15)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
  )
})
```

### World
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    pull(`COVID-19 cases: Deaths`) %>%
    format(big.mark = ",")
  
  de <- HTML(paste0("Total deaths:<br/>", con))
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
  )
})
```

Row  {data-height=500}
-----------------------------------------------------------------------
  
### Explore relationships
```{r}
renderPlotly ({
  
  df2 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable, ]
  df3 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable2, c(1, 6)]
  dfs <- dfm[dfm$date == 2019 & dfm$variable %in% "COVID-19 Cases: Deaths", c(1, 6)]
   
    dfs <- dfs %>%
          rename("siz" = "mrv")

     
    df3 <- df3 %>%
          rename("mrv2" = "mrv")
  
    df4 <- merge(df2, df3, by = c("iso3c"))   
    df4 <- merge(df4, dfs, by = c("iso3c"))  
  
    m <- df4[df4$`Short Name` %in% input$`Country Name`,]
    a <- list(x = m$mrv2, y = m$mrv,
              text = m$`Short Name`, 
              xref = "x", 
              yref = "y",
              showarrow = TRUE, 
              arrowhead = 0, 
              ax = 20, 
              ay = -40, 
              arrowcolor= toRGB("grey80"),
              font = list(color = "dark grey", size = 14)
              )
    
    #df4 <- df4 %>% 
    #  mutate(
    #    opacity = if_else(`Short Name` %in% input$`Country Name`, 0.95, 0.3)
    #  )
    
     texty <- paste("</br>", df4$`Short Name`,
                    "</br>X: ", round(df4$mrv2, 1),
                    "</br>Y: ", round(df4$mrv, 1),
                    "</br>Size: ", round(df4$siz, 1))
     
    
    df4$`Income Group` <- ordered(df4$`Income Group`, 
                                  levels = c("Low income", 
                                             "Lower middle income",
                                             "Upper middle income", 
                                             "High income"))

    plot_ly(data = df4) %>%
      add_trace(
        x = ~ mrv2,
        y = ~ mrv,
        type = 'scatter',
        mode = 'markers',
        color = ~`Income Group`,
        colors = inc_color,
        opacity = 0.9,
        size   = ~siz,
        sizes  = c(20, 100),
      hoverinfo = 'text',
      text = ~ texty
      ) %>%
    #add_annotations(text = df4$lab, textfont = list(size = 14),
    #         textposition = "top right") %>% 
      layout(legend = list(x = 0, 
                           y = -0.3, 
                           orientation = 'h'
                           ),
             annotations = a,
             xaxis = list(type = if_else(input$variable2 %in% covidlog, "log", "linear"),
                          zeroline = FALSE, 
                          showline = FALSE, 
                          showgrid = TRUE, 
                          title = str_wrap((input$variable2), 40),
                          range = c(min(df4$variable), max(df4$variable))
                          ),
             yaxis = list(type = if_else(input$variable %in% covidlog, "log", "linear"),
                          zeroline = FALSE, 
                          showline = FALSE, 
                          showgrid = TRUE, 
                          title = str_wrap(input$variable, 40),
                          range = c(min(df4$variable), max(df4$variable))
                          )
             )
      })
```


### Compare countries over time
```{r}

uiOutput("dynamic")

output$dynamic <- renderUI({ 
  if (input$variable %in% covid){
    plotlyOutput("plot1")
  } else {
    plotlyOutput("plot2")
  }
})

output$plot1 <- renderPlotly({
  
  dft <- fullcd2[fullcd2$`Short Name` %in% input$`Country Name`
                 & fullcd2$variable %in% input$variable,]
  
dft <- dft    %>%
  arrange(date) %>% 
  group_by(Region) %>% 
  mutate(
    op = match(name, unique(name)), 
    opacity = (1-(op/max(op))+1/max(op)),
  ) %>% 
  ungroup() %>% 
  mutate(
    colors = rep(palette, ceil(nrow(.)/length(palette)))[1:nrow(.)]
  )  
  
  # op <- dft %>% 
  #   group_by(`Short Name`) %>% 
  #   summarise(opacity = mean(opacity))
  # 
  # opacity  <- setNames(
  #   op$opacity,
  #   op$`Short Name`
  # )
  # rm(op)
  
  texty <- paste("</br>", dft$`Short Name`,
                 "</br>Y: ", round(dft$value, 2), 
                 "</br>Date: ", dft$date)
  
  plot_ly(data = dft,
          x = ~date,
          y = ~ value ) %>%
    add_trace(

      name  = ~ `Short Name`, 
      type  = 'scatter',
      mode  = 'lines+markers', 
      color = ~`Short Name`,
      colors = cty_color,
      hoverinfo = 'text',
      text = ~ texty
    ) %>%
    layout(
      legend = list(orientation = 'h'),
      xaxis = list(
        title = '',
        zeroline = FALSE,
        showline = FALSE,
        showgrid = TRUE
      ),
      yaxis = list(type = if_else(input$variable %in% covidlog, "log", "linear"),
        title = input$variable,
        zeroline = FALSE,
        showline = FALSE,
        showgrid = TRUE
      )
    )
  
})

output$plot2 <- renderPlotly({
  
  df1 <- dfm[dfm$`Short Name` %in% input$`Country Name` 
             & dfm$variable %in% input$variable,]
  
  df1 <- df1 %>%
    group_by(iso3c) %>%
    arrange(date) %>%
    mutate(date = as.numeric(date)) %>% 
    ungroup() %>% 
    mutate(
      colors = rep(palette, ceil(nrow(.)/length(palette)))[1:nrow(.)]
    )

  
  texty <- paste("</br>", df1$`Short Name`,
                 "</br>Y: ", round(df1$value, 1), 
                 "</br>Year: ", df1$date)
  
  plot_ly(df1) %>%
    add_trace(
      x = ~ date,
      y = ~ value,
      name = ~ `Short Name`,
      type = 'scatter',
      mode = 'lines+markers',
      color = ~`Short Name`,
      colors = cty_color,
      hoverinfo = 'text',
      text = ~ texty
    ) %>%
    layout(legend = list(orientation = 'h'),
           xaxis = list(title = '', 
                        zeroline = FALSE, 
                        showline = FALSE, 
                        showgrid = TRUE
           ), 
           yaxis = list(title = str_wrap(input$variable, 40), 
                        zeroline = FALSE, 
                        showline = FALSE, 
                        showgrid = TRUE
           )
    )
  
})

```

COVID-19 Case Data
=====================================
  
Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------
Last Updated on: `r today`
  
```{r}

radioButtons("var",
             "",
             choices = covid_treemap,  
             selected = "COVID-19 Cases: Confirmed"
)   

getind <- reactive({
  input$var
})

```

Row
-----------------------------------------------------------------------
### `r renderText(getind())`
  
```{r}
renderPlotly({
  
  tmp <- fullcd2[(fullcd2$variable %in% input$var),]  
  
  tmp <- tmp[tmp$date == max(tmp$date),]
  tmp <- tmp[!is.na(tmp$Region),]
  
  # Compute regional aggregates
  tmp2 <- tmp %>%
    select(Region) %>%
    distinct() %>%
    mutate(
      `Short Name` = unique(Region),
      Region = "World",
      value = 0
    )
  
  # Combine Regional aggregates with country level data
  tmp3 <- bind_rows(tmp, tmp2) %>%
    select(Region, `Short Name`, value) %>%
    filter(
      Region %in% c("World", "Europe & Central Asia", "East Asia & Pacific", 
                    "North America", "Middle East & North Africa", "Latin America & Caribbean", 
                    "South Asia", "Sub-Saharan Africa")
    ) %>% 
    left_join(color_map2) %>% 
    left_join(color_map2, by = c("Short Name" = "Region")) %>% 
    mutate(
      color = if_else(is.na(color.x), color.y, color.x)
    ) %>% 
    select(-color.x, -color.y)
  
  tmp3 %>%
    plot_ly( 
      type    = "treemap",
      labels  = ~`Short Name`,
      parents = ~Region,
      values  = ~value,
      marker  = list(colors = ~color)
    ) 
  
})


```


### `r renderText(getind())`

```{r}

renderPlotly({
  
  dfb <- fullcd2 %>% 
    filter(date == max(date),
           variable %in% input$var) %>%
    arrange(desc(value))  %>%
    mutate(`Short Name` = fct_reorder(`Short Name`, desc(value))) %>% 
    slice(1:20)
  
  texty <- paste("</br>", dfb$`Short Name`,
                 "</br>Y: ", dfb$value, 
                 "</br>Date: ", dfb$date)
  
  plot_ly(dfb, 
          type = 'bar', 
          x = ~`Short Name`, 
          y = ~value, 
          color = ~Region,
          colors = reg_color,
          hoverinfo = 'text',
          text = ~ texty
  ) %>% 
    layout(
      legend = list(orientation = 'h', 
                    y = 100, 
                    x = 0),
      xaxis = list(title = '', 
                   zeroline = FALSE, 
                   showline = FALSE, 
                   showgrid = TRUE
      ), 
      yaxis = list(title = '', 
                   zeroline = FALSE, 
                   showline = FALSE, 
                   showgrid = TRUE
      )
    )
})


```


Risk comparison
=====================================
Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------
Last Updated on: `r today`
  
```{r}

radioButtons("type",
             "",
             choices = c("Population", "Health"),  
             selected = "Population"
)   

```

Row
-----------------------------------------------------------------------
### Low income
```{r}
uiOutput("dynamic2")

output$dynamic2 <- renderUI({ 
   if (input$type == "Population")
   {
     plotlyOutput("pop1")
   } else {
     plotlyOutput("pop2")
   } 
 }) 

output$pop1 <- renderPlotly({

lic <-   pyr("LIC")  
lic

})

output$pop2 <- renderPlotly({

hic <-   pyr("HIC")  
hic

})

```

### Lower-middle income
```{r}

uiOutput("dynamic3")

output$dynamic3 <- renderUI({ 
   if (input$type == "Population")
   {
     plotlyOutput("pop3")
   } else {
     NULL
        } 
 }) 

output$pop3 <- renderPlotly({

lmc <-   pyr("LMC")  
 
lmc

})

```

Row
-----------------------------------------------------------------------
### Upper-middle income
```{r}

renderPlotly({

umc <-   pyr("UMC")  
 
umc

})

```

### High income
```{r}

renderPlotly({

hic <-   pyr("HIC")  
 
hic

})

```