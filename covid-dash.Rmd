---
title: "Understanding the COVID-19 pandemic through data"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
source("styles.R")
source("00_setup.R")
source("03_load_data.R")
my_date <- max(wld_data$date)

```


WDI Data
=====================================

Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------

```{r}

selectInput("variable",
               "Indicator Y-axis:",
                choices = list(
                  `Age & Population` = age_pop,
                  `COVID-19` = covid,
                   Health = health,
                  `Water & Sanitation` = water),  
                selected = "COVID-19 Cases: Confirmed"
                )    

selectInput("variable2",
               "Indicator X-axis:",
                choices = list(
                  `Age & Population` = age_pop,
                  `COVID-19` = covid,
                   Health = health,
                  `Water & Sanitation` = water),                
            selected = "Hospital beds (per 1,000 people)"
                ) 

selectInput("size",
               "Bubble size:",
                choices = list(
                  `Age & Population` = age_pop,
                  `COVID-19` = covid,
                   Health = health,
                  `Water & Sanitation` = water),                
            selected = "Population ages 65 and above (% of total)"
                ) 

selectizeInput("Country Name",
                "Country (compare countries over time):",
                c(unique(as.character(dfm$`Short Name`))),
                multiple = TRUE, selected = c("China", "Italy"))

```

Row  {data-height=130}
-----------------------------------------------------------------------
### World, `r my_date`
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(`COVID-19 cases: Confirmed`)
    con <- format(con, big.mark=",")
    de <- paste0("Confirmed: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
           )
})
```

### World, `r my_date`
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(`COVID-19 cases: Active`)
    con <- format(con, big.mark=",")
    de <- paste0("Active: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
           )
})
```

### World, `r my_date`
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(`COVID-19 cases: Deaths`)
  con <- format(con, big.mark=",")
  de <- paste0("Deaths: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
           )
})
```

Row  {data-height=500}
-----------------------------------------------------------------------

### Explore relationships
```{r}
renderPlotly ({

  df2 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable, ]
  df3 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable2, c(1, 6)]
  dfs <- dfm[dfm$date == 2019 & dfm$variable %in% input$size, c(1, 6)]
   
    dfs <- dfs %>%
          rename("siz" = "mrv")

     
    df3 <- df3 %>%
          rename("mrv2" = "mrv")
  
    df4 <- merge(df2, df3, by = c("iso3c"))   
    df4 <- merge(df4, dfs, by = c("iso3c"))  
  

  plot_ly(data = df4) %>%
    add_trace(x = ~mrv2, y = ~mrv, type = 'scatter', mode = 'markers', color = ~Region, size = ~siz, 
              opacity = ifelse(df4$`Short Name` %in% input$`Country Name`, 1, 0.7), ## opacity not working
              hoverinfo = 'text',
              text = ~paste(df4$`Short Name`)) %>%
      layout(legend = list(x = 0, y = -0.2, orientation = 'h'),
             xaxis = list(zeroline = FALSE, showline = FALSE, showgrid = T, title = input$variable2,
                          range = c(min(df4$variable), max(df4$variable))),
             yaxis = list(zeroline = FALSE, showline = FALSE, showgrid = T, title = input$variable,
                          range = c(min(df4$variable), max(df4$variable))))
      })

```


### Compare countries over time
```{r}

uiOutput("dynamic")

output$dynamic <- renderUI({ 
  if (input$variable == "COVID-19 Cases: Confirmed" | input$variable == "COVID-19 Cases: Recovered" |
      input$variable == "COVID-19 Cases: Deaths" | input$variable == "COVID-19 Cases: Active") {
    plotlyOutput("plot1")
  } else {
    plotlyOutput("plot2")
  }
})

output$plot1 <- renderPlotly({
  
  dft <- fullcd2[fullcd2$`Short Name` %in% input$`Country Name` & fullcd2$variable %in% input$variable,]  

  dft %>%
  arrange(date) %>%
  plot_ly() %>%
  add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'lines',
            color = ~`Short Name`) %>%
      add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'markers',
            color = ~`Short Name`, showlegend = FALSE) %>%
  layout(legend = list(orientation = 'h'),
         xaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T), 
         yaxis = list(title = input$variable, zeroline = FALSE, showline = FALSE, showgrid = T))

})

output$plot2 <- renderPlotly({
    
  df1 <- dfm[dfm$`Short Name` %in% input$`Country Name` & dfm$variable %in% input$variable,]  

  plot_ly(df1) %>%
  add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'lines',
            color = df1$iso3c) %>%
      add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'markers',
            color = df1$iso3c, showlegend = FALSE) %>%
  layout(xaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T), 
         yaxis = list(title = input$variable, zeroline = FALSE, showline = FALSE, showgrid = T))

})

```

COVID-19 Cases
=====================================

Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------

```{r}

selectInput("Country",
                "Country:",
                c(unique(as.character(dfm$`Short Name`))),
                 selected = "China")

```

Row  {data-height=130}
-----------------------------------------------------------------------
### Selected country, `r my_date`
```{r}

renderValueBox({
    con <- fullcd2[(fullcd2$variable == "COVID-19 Cases: Confirmed" &
                   fullcd2$date == max(fullcd2$date) &
                   fullcd2$`Short Name` == input$Country), "value"]
    con <- format(con, big.mark=",")
    de <- paste0("Confirmed: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;"),
           icon = "fa-users")
})
```

### Selected country, `r my_date`
```{r}
renderValueBox({
    con <- fullcd2[(fullcd2$variable == "COVID-19 Cases: Active" &
                   fullcd2$date == max(fullcd2$date) &
                   fullcd2$`Short Name` == input$Country), "value"]
    con <- format(con, big.mark=",")
    de <- paste0("Active: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;"),
           icon = "fa-users")
})
```

### Selected country, `r my_date`
```{r}
renderValueBox({
    con <- fullcd2[(fullcd2$variable == "COVID-19 Cases: Deaths" &
                   fullcd2$date == max(fullcd2$date) &
                   fullcd2$`Short Name` == input$Country), "value"]
    con <- format(con, big.mark=",")
    de <- paste0("Deaths: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;"),
           icon = "fa-users")
})
```

Row
-----------------------------------------------------------------------
### Cumulative confirmed cases

```{r}
renderPlotly({
  
  tmp <- tmp[tmp$date == max(tmp$date),]
  
  
tmp <- tmp[!is.na(tmp$Region),]

tmp$Region <- gsub(" ", "", tmp$Region, fixed = TRUE)
tmp$name <- gsub(" ", "", tmp$name, fixed = T)
plot_ly(tmp, 
  type="treemap",
  labels=tmp$name,
  parents=tmp$Region)


 # plot_ly(tmp,
#  type="treemap",
#  labels=c("Eve", "Cain", "Seth", "Enos", "Noam", "Abel", "Awan", "Enoch", "Azura"),
#  parents=c("", "Eve", "Eve", "Seth", "Seth", "Eve", "Eve", "Awan", "Eve")
#)
  
})

# plot_treemap <- function(input, case_type) {
# 
#   tmp <- tmp[tmp$date == max(tmp$date),]
# 
# 
#   p <-  treemap(tmp,
#             draw = T,
#                index=c("Region", "name"),
#                vSize="value",
#                type="index",
#                palette = "Set2",
#                bg.labels = 150,
#                title = "",
#                border.col = "white",
#                inflate.labels=F,
#                fontsize.labels=c(15,13),
#                overlap.labels=0,
#                align.labels=list(
#                  c("left", "top"),
#                  c("center", "center"),
#                border.lwds=c(1,1)
#                )
# #    ),
# #    rootname = "World"
#   )
# 
#   return(p)
# }
#   renderPlot({
#   plot_treemap(input, "COVID-19 Cases: Confirmed")
# })

#
# ### Bubble map
# ```{r}
# leaflet(ccc) %>%
#   addTiles()  %>%
#   addCircleMarkers(~longitude, ~latitude, label = ~longlab,
#                    radius = ~ sqrt(mrv/10),
#                    stroke = FALSE, fillOpacity = 0.5, weight = 1)
#

# figure(
#        data = ccc,
#         plot = function(cnm, style = style_atlas_open(), quality = "low") {
#         breaks = c(200, 5000, 20000)
#         wbg_bubble_map(cnm, wbgmaps[[quality]], style, "mrv",
#         breaks,
#         max_size = 2
#         )
#         },
#         aspect_ratio = 1.5
#        )

# renderLeaflet({
#
#   h <- reactive({
#     a <- ccc[ccc$date %in% input$date,]
#   })
#
#   leaflet(h()) %>%
#     addTiles()  %>%
#     addCircleMarkers(h()$longitude, h()$latitude, label = h()$longlab,
#                      radius = h()$sqrt(value/10),
#                      stroke = FALSE, fillOpacity = 0.5, weight = 1)
#
# })

```


### New cases confirmed on `r my_date`

```{r}

plot_treemap2 <- function(input, case_type) {

  tmp1 <- tmp[tmp$date == max(tmp$date),]
  tmp2 <- tmp[tmp$date == (max(tmp$date) - 1), c(1, 5)]
  tmp2 <- tmp2 %>%
            rename("val2" = "value")

  tmp1 <- merge(tmp1, tmp2, by = "iso", all.x = T)

  tmp1$new <- tmp1$value - tmp1$val2

    #  p <- d3tree3(
   p <-  treemap(tmp1,
            draw = T,
               index=c("Region", "name"),
               vSize="new",
               type="index",
               palette = "Set2",
               bg.labels = 150,
               title = "",
               border.col = "white",
               inflate.labels=F,
               fontsize.labels=c(15,13),
               overlap.labels=0,
               align.labels=list(
                 c("left", "top"),
                 c("center", "center"),
               border.lwds=c(1,1)
               )
#    ),
#    rootname = "World"
  )

  return(p)
}

renderPlot({
  plot_treemap2(input, "COVID-19 Cases: Confirmed")
})
```
