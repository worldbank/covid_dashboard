---
title: "Development data and COVID-19 pandemic"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}

source("styles.R")
source("00_setup.R")
library(pins)
board_register_rsconnect("rsconnect", 
                         server = "http://w0lxopshyprd1b.worldbank.org:3939")

# Retrieve Pin 

names <- c(
  "dfm",
  "ccc",
  "fullcd",
  "wld_data",
  "ctry_data",
  "full_country_data",
  "indicator_list",
  "df"
)

for (i in seq_along(names)) {
  fullname <- paste0("tonyfujs/", names[i])
  f        <- pin_get(fullname, board = "rsconnect")
  assign(names[i], f)
}

```

Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------

```{r}

selectInput("variable",
               "Indicator A:",
                choices = c(unique(as.character(dfm$variable))),                       
                selected = "confirmed"
                )    

selectInput("variable2",
               "Indicator B:",
                choices = c(unique(as.character(dfm$variable))),                       
                selected = "Hospital beds (per 1,000 people)"
                ) 

selectInput("size",
               "Size:",
                choices = c(unique(as.character(dfm$variable))),                       
                selected = "Population ages 65 and above (% of total)"
                ) 

selectizeInput("Country Name",
                "Country:",
                c(unique(as.character(dfm$`Short Name`))),
                multiple = TRUE, selected = c("China", "Italy"))

# sliderInput(inputId = "date",
#                         label = "Date:",
#                         min = min(ccc$date), max = max(ccc$date), sep = "",
#                         value = max(ccc$date), animate = animationOptions(interval = 1000))




```

Row  {data-height=500}
-----------------------------------------------------------------------
```{r}
renderPlotly ({

  df2 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable, ]
  df3 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable2, c(1, 7)]
  dfs <- dfm[dfm$date == 2019 & dfm$variable %in% input$size, c(1, 7)]
   
    dfs <- dfs %>%
          rename("siz" = "mrv")
  
    df3 <- df3 %>%
          rename("mrv2" = "mrv")
  
    df4 <- merge(df2, df3, by = c("iso3c"))   
    df4 <- merge(df4, dfs, by = c("iso3c"))          

  plot_ly(data = df4) %>%
    add_trace(x = ~mrv, y = ~mrv2, type = 'scatter', mode = 'markers', color = ~Region,
              marker = list(size = ~siz, 
                            opacity = ifelse(df4$name %in% input$`Country Name`, 1, 0.5)),
              hoverinfo = 'text',
              text = ~paste(df4$name)) %>%
      layout(xaxis = list(zeroline = FALSE, showline = FALSE, showgrid = T, title = ""),
             yaxis = list(zeroline = FALSE, showline = FALSE, showgrid = T, title = ""))
      })

# renderggiraph({
#   
#   df2 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable, ]
#   df3 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable2, c(1, 7)]
#   dfs <- dfm[dfm$date == 2019 & dfm$variable %in% input$size, c(1, 7)]
# 
#   dfs <- dfs %>%
#           rename("siz" = "mrv")
#   
#   df3 <- df3 %>%
#           rename("mrv2" = "mrv")
#   
#   df4 <- merge(df2, df3, by = c("iso3c"))   
#   df4 <- merge(df4, dfs, by = c("iso3c"))   
#   
#   gp <- ggplot(data = df4) +
#           geom_point_interactive(aes(x = mrv, y = mrv2, color = factor(Region),
#           size = siz, tooltip = name), alpha = ifelse(df4$name %in% input$`Country Name`, 1, 0.5)) + 
#         theme_minimal() +
#         theme(
#           axis.title = element_blank(),
#           legend.position = "bottom",
#           legend.title = element_blank()
#             )
# 
# girafe(ggobj = gp)
#   
# })


```

Row  {data-height=100}
-----------------------------------------------------------------------
### World
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(confirmed)
    de <- paste0("Confirmed: ", con)
  valueBox(de, icon = "fa-users")
})
```

### World
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(deaths)
  de <- paste0("Deaths: ", con)
  valueBox(de, icon = "fa-users")
})
```

### World
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(recovered)
    de <- paste0("Recovered: ", con)
  valueBox(de, icon = "fa-users")
})
```

Row  {data-height=400}
-----------------------------------------------------------------------
### Treemap
```{r}
ccc2 <- dfm[dfm$variable == "confirmed",]

d3tree2(
  treemap(ccc2,
          draw = F,
             index=c("Region", "name"),
             vSize="mrv",
             type="index",
             palette = "Set2",
             bg.labels = 150,
             title = "",
             border.col = "white",
             align.labels=list(
               c("center", "center"), 
               c("right", "bottom")
             )
      ),  
      rootname = "World" )

```

### Bubble map
```{r}
leaflet(ccc) %>% 
  addTiles()  %>% 
  addCircleMarkers(~longitude, ~latitude, label = ~longlab,
                   radius = ~ sqrt(mrv/10),
                   stroke = FALSE, fillOpacity = 0.5, weight = 1) 


# figure(
#        data = ccc,
#         plot = function(cnm, style = style_atlas_open(), quality = "low") {
#         breaks = c(200, 5000, 20000)
#         wbg_bubble_map(cnm, wbgmaps[[quality]], style, "mrv",
#         breaks,
#         max_size = 2
#         )
#         },
#         aspect_ratio = 1.5
#        )

# renderLeaflet({
#   
#   h <- reactive({
#     a <- ccc[ccc$date %in% input$date,]
#   })
#   
#   leaflet(h()) %>% 
#     addTiles()  %>% 
#     addCircleMarkers(h()$longitude, h()$latitude, label = h()$longlab,
#                      radius = h()$sqrt(value/10),
#                      stroke = FALSE, fillOpacity = 0.5, weight = 1)  
#   
# })

```


### Trend chart

```{r}

uiOutput("dynamic")

output$dynamic <- renderUI({ 
  if (input$variable == "confirmed" | input$variable == "recovered" |
      input$variable == "deaths") {
    plotlyOutput("plot1")
  } else {
    plotlyOutput("plot2")
  }
})


output$plot1 <- renderPlotly({
  
  dft <- fullcd[fullcd$name %in% input$`Country Name` & fullcd$variable %in% input$variable,]  

  plot_ly(dft) %>%
  add_trace(x = ~date, y = ~value, name = ~iso, type = 'scatter', mode = 'lines',
            color = dft$iso) %>%
      add_trace(x = ~date, y = ~value, name = ~iso, type = 'scatter', mode = 'markers',
            color = dft$iso, showlegend = FALSE) %>%
  layout(xaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T), 
         yaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T))

})

output$plot2 <- renderPlotly({
    
  df1 <- dfm[dfm$`Short Name` %in% input$`Country Name` & dfm$variable %in% input$variable,]  

  plot_ly(df1) %>%
  add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'lines',
            color = df1$iso3c) %>%
      add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'markers',
            color = df1$iso3c) %>%
  layout(xaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T), 
         yaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T))

})

```

