---
title: "Understanding the COVID-19 pandemic through data"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
source("styles.R")
source("00_setup.R")
source("03_load_data.R")
my_date <- max(wld_data$date)

#--------- filtered cases
covid <- grep("(Confirmed|Deaths)", covid, value = TRUE)

#--------- new cases
# Country level
new_c <- fullcd2 %>%  # New cases
  arrange(iso, variable, date)        %>% 
  group_by(iso, variable)             %>% 
  mutate(
    new    = value - lag(value, 
                         order_by = date),
    status = gsub("COVID-19 Cases: ", "", variable)
  )                                   %>% 
  filter(date == max(date)) %>% 
  ungroup()                 %>% 
  select(iso, status, new)

# world level
new_wl <- new_c    %>% 
  group_by(status) %>% 
  summarise(con = sum(new))



```


WDI Data
=====================================

Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------

```{r}

selectInput("variable",
               "Indicator Y-axis:",
                choices = list(
                  `Age & Population` = age_pop,
                  `COVID-19` = covid,
                   Health = health,
                  `Water & Sanitation` = water),  
                selected = "COVID-19 Cases: Deaths"
                )    

selectInput("variable2",
               "Indicator X-axis:",
                choices = list(
                  `Age & Population` = age_pop,
                  `COVID-19` = covid,
                   Health = health,
                  `Water & Sanitation` = water),                
            selected = "Hospital beds (per 1,000 people)"
                ) 

selectInput("size",
               "Bubble size:",
                choices = list(
                  `Age & Population` = age_pop,
                  `COVID-19` = covid,
                   Health = health,
                  `Water & Sanitation` = water),                
            selected = "Population ages 65 and above (% of total)"
                ) 

selectizeInput("Country Name",
                "Country (compare countries over time):",
                c(unique(as.character(dfm$`Short Name`))),
                multiple = TRUE, selected = c("China", "Italy", "United States", "Spain", "Iran"))

```

Row  {data-height=130}
-----------------------------------------------------------------------
### World, `r my_date`
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(`COVID-19 cases: Confirmed`)
    con <- format(con, big.mark=",")
    de <- paste0("Confirmed: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
           )
})
```

### World, `r my_date`
```{r}
renderValueBox({
  con <- new_wl %>% 
        filter(status == "Confirmed") %>% 
        select(con) %>% 
        pull() %>% 
        format(big.mark=",")
      
  de <- paste0("New cases: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
           )
})
```

### World, `r my_date`
```{r}
renderValueBox({
  con <- wld_data %>%
    filter(wld_data$date == max(wld_data$date)) %>%
    select(`COVID-19 cases: Deaths`)
  con <- format(con, big.mark=",")
  de <- paste0("Deaths: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #, 
           #icon = "fa-users"
           )
})
```

Row  {data-height=500}
-----------------------------------------------------------------------

### Explore relationships
```{r}
renderPlotly ({

  df2 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable, ]
  df3 <- dfm[dfm$date == 2019 & dfm$variable %in% input$variable2, c(1, 6)]
  dfs <- dfm[dfm$date == 2019 & dfm$variable %in% input$size, c(1, 6)]
   
    dfs <- dfs %>%
          rename("siz" = "mrv")

     
    df3 <- df3 %>%
          rename("mrv2" = "mrv")
  
    df4 <- merge(df2, df3, by = c("iso3c"))   
    df4 <- merge(df4, dfs, by = c("iso3c"))  
  

  plot_ly(data = df4) %>%
    add_trace(x = ~mrv2, y = ~mrv, type = 'scatter', mode = 'markers', color = ~Region, size = ~siz, 
              opacity = ifelse(df4$`Short Name` %in% input$`Country Name`, 1, 0.7), ## opacity not working
              hoverinfo = 'text',
              text = ~paste(df4$`Short Name`)) %>%
      layout(legend = list(x = 0, y = -0.2, orientation = 'h'),
             xaxis = list(zeroline = FALSE, showline = FALSE, showgrid = T, title = input$variable2,
                          range = c(min(df4$variable), max(df4$variable))),
             yaxis = list(zeroline = FALSE, showline = FALSE, showgrid = T, title = input$variable,
                          range = c(min(df4$variable), max(df4$variable))))
      })

```


### Compare countries over time
```{r}

uiOutput("dynamic")

output$dynamic <- renderUI({ 
  if (input$variable %in% covid)
      #== "COVID-19 Cases: Confirmed" | input$variable == "COVID-19 Cases: Recovered" |
      #input$variable == "COVID-19 Cases: Deaths" | input$variable == "COVID-19 Cases: Active"
       {
    plotlyOutput("plot1")
  } else {
    plotlyOutput("plot2")
  }
})

output$plot1 <- renderPlotly({
  
  dft <- fullcd2[fullcd2$`Short Name` %in% input$`Country Name` & fullcd2$variable %in% input$variable,]  

  dft %>%
  arrange(date) %>%
  plot_ly() %>%
  add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'lines',
            color = ~`Short Name`) %>%
      add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'markers',
            color = ~`Short Name`, showlegend = FALSE) %>%
  layout(legend = list(orientation = 'h'),
         xaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T), 
         yaxis = list(title = input$variable, zeroline = FALSE, showline = FALSE, showgrid = T))

})

output$plot2 <- renderPlotly({
    
  df1 <- dfm[dfm$`Short Name` %in% input$`Country Name` & dfm$variable %in% input$variable,]  

  plot_ly(df1) %>%
  add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'lines',
            color = df1$iso3c) %>%
      add_trace(x = ~date, y = ~value, name = ~`Short Name`, type = 'scatter', mode = 'markers',
            color = df1$iso3c, showlegend = FALSE) %>%
  layout(xaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T), 
         yaxis = list(title = input$variable, zeroline = FALSE, showline = FALSE, showgrid = T))

})

```

COVID-19 Cases
=====================================

Sidebar { .sidebar data-width=250}
-----------------------------------------------------------------------

```{r}

selectInput("Country",
                "Country:",
                c(unique(as.character(dfm$`Short Name`))),
                 selected = "China")

selectInput("var",
               "COVID Indicator:",
                choices = covid,  
                selected = "COVID-19 Cases: Confirmed"
                )   

```

Row  {data-height=130}
-----------------------------------------------------------------------
### Selected country, `r my_date`
```{r}

renderValueBox({
    con <- fullcd2[(fullcd2$variable == "COVID-19 Cases: Confirmed" &
                   fullcd2$date == max(fullcd2$date) &
                   fullcd2$`Short Name` == input$Country), "value"]
    con <- format(con, big.mark=",")
    de <- paste0("Confirmed: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #,
           #icon = "fa-users"
           )
})
```

### Selected country, `r my_date`
```{r}
renderValueBox({
    con <- fullcd2[(fullcd2$variable == "COVID-19 Cases: Active" &
                   fullcd2$date == max(fullcd2$date) &
                   fullcd2$`Short Name` == input$Country), "value"]
    con <- format(con, big.mark=",")
    de <- paste0("Active: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #,
           #icon = "fa-users"
           )
})
```

### Selected country, `r my_date`
```{r}
renderValueBox({
    con <- fullcd2[(fullcd2$variable == "COVID-19 Cases: Deaths" &
                   fullcd2$date == max(fullcd2$date) &
                   fullcd2$`Short Name` == input$Country), "value"]
    con <- format(con, big.mark=",")
    de <- paste0("Deaths: ", con)
  valueBox(tags$p(de, style = "font-size: 80%;")
           #,
           #icon = "fa-users"
           )
})
```

Row
-----------------------------------------------------------------------
### Cumulative confirmed cases

```{r}
renderPlotly({

tmp <- fullcd2[(fullcd2$variable %in% input$var),]  
  
tmp <- tmp[tmp$date == max(tmp$date),]
tmp <- tmp[!is.na(tmp$Region),]

# Compute regional aggregates
tmp2 <- tmp %>%
  group_by(Region) %>%
  summarise(
    `Short Name` = unique(Region),
    value = sum(value)
  ) %>%
  mutate(
    Region = "World"
  ) %>%
  ungroup()

# Combine Regional aggregates with country level data
tmp3 <- bind_rows(tmp, tmp2) %>%
  select(Region, `Short Name`, value) %>%
  filter(
    Region %in% c("World", "Europe & Central Asia", "East Asia & Pacific", 
                  "North America", "Middle East & North Africa", "Latin America & Caribbean", 
                  "South Asia", "Sub-Saharan Africa")
  )
  

tmp3 %>%
  plot_ly( 
        type    = "treemap",
        labels  = tmp3$`Short Name`,
        parents = tmp3$Region,
        values  = tmp3$value
        )

})


```


### Countries with maximum cases confirmed by `r my_date`

```{r}

renderPlotly({
  
  fullcd2 <- fullcd2[fullcd2$date == max(fullcd2$date),]
  fullcd2 <- fullcd2 %>%
          filter(variable %in% input$var) %>%
          arrange(desc(value))  %>%
          mutate(`Short Name` = fct_reorder(`Short Name`, desc(value)))
  
  fullcd2 <- fullcd2[c(1:20),]
  
  plot_ly(fullcd2, x = ~`Short Name`, y = ~value, type = 'bar', color = ~Region) %>% 
              layout(xaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T), 
                     yaxis = list(title = '', zeroline = FALSE, showline = FALSE, showgrid = T))
  
  
})


```


Center of gravity
=====================================
```{r}
# Loading global shapefile converted into rda
load(file = "input/area_df.rda")


# Map over daily deaths
map_deaths = ggplot() +
  geom_polygon(data = area_df, 
               aes(x = long, y = lat, group=group),
               color = 'white',size=0.1) + 
  theme(panel.background = element_rect(fill='white', color='white'), legend.text=element_text(size=14), legend.title=element_text(size=14)) +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) +
  geom_point(data = cg_data, aes(x=longitude_newdeaths_rol, y=latitude_newdeaths_rol, size=total_newdeaths, color=date)) +
  scale_colour_date(low = "#FF7878", high = "#780000")+labs(size="Daily deaths", color="Date") +
  ggtitle("Center of Gravity of COVID-19 Deaths")+theme(plot.title = element_text(hjust = 0.5,face="bold",size=20))
#plot(map_deaths)

# Map over daily confirmed
map_confirmed = ggplot() +
  geom_polygon(data = area_df, 
               aes(x = long, y = lat, group=group),
               color = 'white',size=0.1) + 
  theme(panel.background = element_rect(fill='white', color='white'), legend.text=element_text(size=14), legend.title=element_text(size=14)) +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) +
  geom_point(data = cg_data, aes(x=longitude_newconfirmed_rol, y=latitude_newconfirmed_rol, size=total_newconfirmed, color=date)) +
  scale_colour_date(low = "#7878FF", high = "#000078")+labs(size="Daily new cases", color="Date")+
  ggtitle("Center of Gravity of COVID-19 Cases")+theme(plot.title = element_text(hjust = 0.5,face="bold",size=20))

#plot(map_confirmed)

renderPlot({
  
  map_deaths
  
  
})

```